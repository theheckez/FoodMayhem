<!DOCTYPE html>
<html lang="es">

<head>
  <meta name="" charset="utf-8" content=""/>
  <title>Food Mayhem</title>
    <script src="js/phaser.min.js"></script>
    <script src="js/stateMachinePlayer.js"></script>
    <script src="js/enemiesClasses.js"></script>
    <script src="js/playerClasses.js"></script>
    <script src="js/Pantallas.js"></script>
    <script src="js/misc.js"></script>
</head>

<body style="text-align:center">

<script type="text/javascript">

var vidaP1;
var vidaP2;

var MainGame = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:

        function MainGame() {
          Phaser.Scene.call(this, { key: 'mainGame' });

          this.player;
          this.player2;
          this.players;
          this.enemies;

          this.life1;

        },

      preload: function () {
        //Im치genes de escenario
        this.load.image('map', 'assets/map1.png');
        this.load.image('valla', 'assets/vallas/valla1.png');
        this.load.image('valla1', 'assets/vallas/valla2.1.png');
        this.load.image('valla2', 'assets/vallas/valla2.2.png');
        this.load.image('valla3', 'assets/vallas/valla3.png');
        this.load.image('arbolB', 'assets/arboles/arbolBlanco.png');
        this.load.image('arbolN', 'assets/arboles/arbolNaranja.png');
        this.load.image('arbolR', 'assets/arboles/arbolRosa.png');
        this.load.image('arbolV', 'assets/arboles/arbolVerde.png');

        this.load.image('lifeBarP1', 'assets/interfaz/barraVidaP1.png');
        this.load.image('lifeBarP2', 'assets/interfaz/barraVidaP2.png');
        this.load.image('BckBarP1', 'assets/interfaz/fondoBarraP1.png');
        this.load.image('BckBarP2', 'assets/interfaz/fondoBarraP2.png');


        //Inventario
        this.load.image('inventoryOpenP1', 'assets/interfaz/inventarioAbierto.png');
        this.load.image('inventoryClosedP1', 'assets/interfaz/inventarioCerrado.png');
        this.load.image('inventoryOpenP2', 'assets/interfaz/inventarioAbiertoP2.png');
        this.load.image('inventoryClosedP2', 'assets/interfaz/inventarioCerradoP2.png');
        this.load.image('sword', 'assets/players/espada.png');
        this.load.image('swordSelec', 'assets/players/espadaSelec.png');
        this.load.image('wand', 'assets/players/varitaSauco.png');
        this.load.image('wandSelec', 'assets/players/weapon_select.png');

        this.load.image('bolaP1', 'assets/players/bola.png');
        this.load.image('bolaP2', 'assets/players/bolaP2.png');


        this.load.spritesheet('musicButton', 'assets/interfaz/BotonMutearMusica-sheet.png',
         { frameWidth: 57, frameHeight: 41 });


        //Im치genes de Icy
        this.load.spritesheet('icy', 'assets/players/icy.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icyB', 'assets/players/Yci.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('yciattack', 'assets/players/yciattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icyattack', 'assets/players/icyattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icydmg', 'assets/players/dmg.png',{ frameWidth: 64, frameHeight: 64 });

        //Im치genes de Enemigos
        this.load.spritesheet('malvin', 'assets/enemies/malvin.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('demon', 'assets/enemies/demon.png', { frameWidth: 32, frameHeight: 32 })
        this.load.spritesheet('malvinattack', 'assets/enemies/malvinattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('malvindeath', 'assets/enemies/malvinDeath.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('pause', 'assets/interfaz/botonPause.png', { frameWidth: 80, frameHeight: 47 });


        //Sounds
        this.load.audio('escMusic', [
          'assets/sounds/musicEsc.mp3'
        ]);
        this.load.audio('hitSound', ['assets/sounds/icyHit.mp3']);
      },

      create: function () {
        this.add.image(400, 380, 'map');
        this.input.mouse.disableContextMenu();

        this.blocks = this.physics.add.staticGroup();
        this.trees = this.physics.add.staticGroup();

        this.blocks.create(80, 65, 'valla').setScale(0.95).refreshBody();
        this.blocks.create(410, 139, 'valla1').setScale(0.95).refreshBody();
        this.blocks.create(547, 101, 'valla2').setScale(0.95).refreshBody();
        this.blocks.create(410, 334, 'valla3').setScale(0.95).refreshBody();

        //  this.smth = new EnemyMM(this,500,500,'malvin');

        //Declaraci칩n de PJs y NPCs
        this.enemies = this.add.group({
          classType: Malvin,
          runChildUpdate: false
        });

        this.bosses = this.add.group({
          classType: DemonBoss,
          runChildUpdate: false
        });

        this.generateEnemies(5, this.enemies, 'malvin');
        this.generateEnemies(1, this.bosses, 'demon');
        this.generateTrees(2);

        //Jugadores
        this.player = new P1(this, 300, 450);
        this.player2 = new P2(this, 500, 450);
        this.players = [this.player, this.player2];

        //Control de colisiones de mundo
        this.initCollisions();

        // BOTONES
        var pauseButton = this.add.sprite(400, 22, 'pause', 0).setInteractive();
      var musicButton = this.add.sprite(400, 570, 'musicButton', 0).setInteractive();
      var musicBtDown = this.add.sprite(400, 570, 'musicButton', 2).setInteractive().setVisible(false);

        // BARRAS DE VIDA
        this.add.image(100, 35, 'BckBarP1');
        this.player.lifeBar = new LifeBar(this, 54, 26, 56, 28);
        this.add.image(100, 35, 'lifeBarP1');

        this.add.image(700, 35, 'BckBarP2');
        this.player2.lifeBar = new LifeBar(this, 614, 26, 690, 28);
        this.add.image(700, 35, 'lifeBarP2');

        //MUSICA
        var music = this.sound.add('escMusic', {loop: true});
  music.play();

  musicButton.on("pointerover", function () {
    musicButton.setFrame(1);
  })
  musicButton.on("pointerout", function () {
    musicButton.setFrame(0);
  })
  musicButton.on('pointerdown', function () {
    console.log("Musica desactivada");
    musicBtDown.visible = true;
    musicButton.visible = false;
    musicBtDown.setFrame(1);
    music.stop()
  })

  musicBtDown.on("pointerover", function () {
    musicBtDown.setFrame(1);
  })
  musicBtDown.on("pointerout", function () {
    musicBtDown.setFrame(2);
  })
  musicBtDown.on('pointerdown', function () {
    console.log("Musica activada");
    musicBtDown.visible = false;
    musicButton.visible = true;
    musicButton.setFrame(1);
    music.play();

  })


        //OPCIONES
            pauseButton.on("pointerover", function () {
              pauseButton.setFrame(1);
            })
            pauseButton.on("pointerout", function () {
              pauseButton.setFrame(0);
            })

            pauseButton.on('pointerdown', function () {
              console.log("Pausa");

              // aqui se cambia al menu de pausa
            });

        this.physics.add.overlap(this.player.attackHitbox, this.enemies, this.enemiesDamaged, undefined, this)
        this.physics.add.overlap(this.player2.attackHitbox, this.enemies, this.enemiesDamaged, undefined, this)
        this.physics.add.overlap(this.player.attackHitbox, this.bosses, this.enemiesDamaged, undefined, this)
        this.physics.add.overlap(this.player2.attackHitbox, this.bosses, this.enemiesDamaged, undefined, this)
      },

      update: function () {

        this.player.move(this, this.enemies);

        this.player2.checkGamepad();

        this.add.existing(this.player2);
        this.physics.add.existing(this.player2);
        this.player2.setCollideWorldBounds(true);
        this.player2.setSize(30, 30);
        this.player2.setOffset(17, 28);
        this.player2.move();


        this.enemies.children.each(function (enem) {
          enem.initEnemy(this.players);
          enem.setSize(30, 30);
          enem.update();
        }, this);

        this.bosses.children.each(function (enem) {
          enem.setScale(2);
          enem.initEnemy(this.players);

        }, this);

        this.checkforLevel();

      },

      initCollisions: function () {
        this.add.existing(this.player);
        this.physics.add.existing(this.player);
        this.player.setCollideWorldBounds(true);
        this.player.setSize(30, 30);
        this.player.setOffset(17, 28);

        //HitBox Enemigos


        //Colisiones de mundo

        this.physics.add.collider(this.player, this.blocks);
        this.physics.add.collider(this.enemies, this.enemies);
        this.physics.add.collider(this.enemies, this.blocks);
        this.physics.add.collider(this.player2, this.blocks);
        this.physics.add.collider(this.bosses, this.enemies);
        this.physics.add.collider(this.bosses, this.blocks);

      },

      generateEnemies: function (number, enemies, sprite) {
        for (var i = 0; i < number; i++) {
          enemies.get(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), sprite);
        }
      },

      generateTrees: function (number) {
        for (var i = 0; i < number; i++) {
          this.blocks.create(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), 'arbolB').setScale(0.6).refreshBody();
          this.blocks.create(Phaser.Math.Between(100, 700)
            , Phaser.Math.Between(100, 500), 'arbolN').setScale(0.6).refreshBody();
          this.blocks.create(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), 'arbolR').setScale(0.6).refreshBody();
          this.blocks.create(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), 'arbolV').setScale(0.6).refreshBody();

        }


      },
      enemiesDamaged: function (player, enemy) {
        enemy.getHurt(player.attackDmg, player.playerKills);
      },

      checkforLevel: function() {
        if(this.enemies.countActive() === 0 && this.bosses.countActive() === 0) {
          this.generateEnemies(Phaser.Math.Between(3,10), this.enemies, 'malvin');
          this.generateEnemies(Phaser.Math.Between(0,4), this.bosses, 'demon');
        }
      }

    });

  const config = {
    type: Phaser.Auto,
    width: 800,
    height: 600,
    input: {
      gamepad: true
    },
    pixelArt: true,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: {y: 0},
        debug: true
      }
    },

    parent: 'container',
    backgroundColor: '#34495E',

    banner:{
    hidePhaser: false,
    text: '#000000',
    background: [
      'red',
      'yellow',
      'red',
      'transparent'
    ]
  },
    scene: [MainGame,PantallaCarga,PantallaInicio,CharacterSelect, PantallaPausa]
  };

  var game = new Phaser.Game(config);

</script>
</body>



</html>
