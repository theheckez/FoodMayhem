<!DOCTYPE html>
<html lang="es">

<head>
  <meta name="" charset="utf-8" content="" />
  <title>Food Mayhem</title>
  <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
</head>

<body>
  <script type="text/javascript">

    var Player = new Phaser.Class({
      Extends: Phaser.Physics.Arcade.Sprite,
      initialize:

        function Player(newScene) {
          Phaser.Physics.Arcade.Sprite.call(this, newScene, 500, 450, 'dude');

          this.timeSinceLastIncrement = -1;

          newScene.add.existing(this);
          newScene.physics.add.existing(this);
          this.setCollideWorldBounds(true);

          this.health = 100;
          this.lifeBar = null;

          this.attackDmg = 20;
          this.attackRange = 50;
          this.attackCooldown = 1;
          this.hitSound = null;

          this.speed = 100;
          this.scene = newScene;

          this.keys;
          this.pad;

          this.initInput();
          this.initAnimations();
          this.initSounds();

        },


      ////////////////////////////////////////////////////////////////////////////////////////////

      move: function (scene) {
        this.pad = this.scene.input.gamepad.getPad(0);

        if (this.scene.input.gamepad.total === 0) {
          this.setVelocity(0);


          if (this.keys['left'].isDown) {
            this.setVelocityX(-this.speed);

            if (!(this.anims.getCurrentKey() === 'up' || this.anims.getCurrentKey() === 'down'))
              this.anims.play('left', true);
          } else if (this.keys['right'].isDown) {
            this.setVelocityX(this.speed);

            if (!(this.anims.getCurrentKey() === 'up' || this.anims.getCurrentKey() === 'down'))
              this.anims.play('right', true);
          }

          if (this.keys['up'].isDown) {
            this.setVelocityY(-this.speed);
            this.anims.play('up', true);
          } else if (this.keys['down'].isDown) {
            this.setVelocityY(this.speed);
            this.anims.play('down', true);
          }

          if (this.body.velocity.equals(new Phaser.Math.Vector2(0, 0)) && !(this.anims.getCurrentKey() === 'punch')) {
            this.anims.play('turn', true);
          }

        } else {
          if (this.pad.axes.length) {

            var axisH = this.pad.axes[0].getValue();
            var axisV = this.pad.axes[1].getValue();

            this.setVelocityX(this.speed * axisH);
            this.setVelocityY(this.speed * axisV);

            if (axisH < 0) {

              if (!(this.anims.getCurrentKey() === 'up' || this.anims.getCurrentKey() === 'down'))
                this.anims.play('left', true);
            } else if (axisH > 0) {

              if (!(this.anims.getCurrentKey() === 'up' || this.anims.getCurrentKey() === 'down'))
                this.anims.play('right', true);
            }

            if (axisV < 0) {

              this.anims.play('up', true);
            } else if (axisV > 0) {
              this.anims.play('down', true);
            }

            if (this.body.velocity.equals(new Phaser.Math.Vector2(0, 0))) {
              this.anims.play('turn', true);
            }
          }
        }
      },

      ////////////////////////////////////////////////////////////////////////////////////////////

      attack: function (targets) {
        this.actualTime = this.scene.time.now / 1000;

        if (this.scene.input.activePointer.isDown) {
          console.log("Pointer Down")
          if (this.actualTime > (this.timeSinceLastIncrement + this.attackCooldown)) {
            console.log("time cooldown")
            this.anims.play('punch', true);
            this.hitSound.play();
            targets.health -= 10;
            console.log("Enemigo dañado");
            console.log("Vida restante = " + targets.health);
            this.timeSinceLastIncrement = this.scene.time.now / 1000;

            if (targets.health == 0) {
              targets.anims.play('malvinDie');
              targets.dead = true;
              targets.destroy();
            }
          }
        }
      },

      ////////////////////////////////////////////////////////////////////////////////////////////

      initAnimations: function () {

        this.scene.anims.create({
          key: 'down',
          frames: this.scene.anims.generateFrameNumbers('icy', { start: 7, end: 12 }),
          frameRate: 10,
          repeat: -1
        });

        this.scene.anims.create({
          key: 'turn',
          frames: this.scene.anims.generateFrameNumbers('icy', { start: 0, end: 4 }),
          frameRate: 10,
          repeat: -1
        });

        this.scene.anims.create({
          key: 'up',
          frames: this.scene.anims.generateFrameNumbers('icy', { start: 14, end: 19 }),
          frameRate: 10,
          repeat: -1
        });

        this.scene.anims.create({
          key: 'left',
          frames: this.scene.anims.generateFrameNumbers('icy', { start: 28, end: 32 }),
          frameRate: 15,
          repeat: -1
        });

        this.scene.anims.create({
          key: 'right',
          frames: this.scene.anims.generateFrameNumbers('icy', { start: 21, end: 25 }),
          frameRate: 15,
          repeat: -1
        })

        this.scene.anims.create({
          key: 'punch',
          frames: this.scene.anims.generateFrameNumbers('icyattack', { frames: [0, 1, 2, 3, 4, 5] }),
          frameRate: 10,
        });
      },

      /////////////////////////////////////////////////////////////////////////////////////////

      initSounds: function () { 
        this.hitSound = this.scene.sound.add('hitSound', { loop: false });
      },

      /////////////////////////////////////////////////////////////////////////////////////////

      initInput: function () {

        this.keys = this.scene.input.keyboard.addKeys({
          'up': Phaser.Input.Keyboard.KeyCodes.W,
          'down': Phaser.Input.Keyboard.KeyCodes.S,
          'left': Phaser.Input.Keyboard.KeyCodes.A,
          'right': Phaser.Input.Keyboard.KeyCodes.D
        });
      }
    });



    ////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////
    ////////////////////////////////////////////////////////////////////////////////////////////////



    var Enemy = new Phaser.Class({
      Extends: Phaser.Physics.Arcade.Sprite,
      initialize:


        function Enemy(newScene) {
          Phaser.Physics.Arcade.Sprite.call(this, newScene, 500, 200, 'malvin');

          this.timeSinceLastIncrement = -3;
          this.actualTime;

          this.health = 100;
          this.speed = 70;
          this.dead = false;

          this.attackDmg = 10;
          this.attackRange = 50;
          this.attackCooldown = 3;

          this.scene = newScene;
          newScene.add.existing(this);
          newScene.physics.add.existing(this);
          this.setCollideWorldBounds(true);

          this.initAnimations();
        },


      ///////////////////////////////////////////////////////////////////////////////////////////

      initAnimations: function () {
        this.scene.anims.create({
          key: 'malvinDown',
          frames: this.scene.anims.generateFrameNumbers('malvin', { start: 0, end: 5 }),
          frameRate: 10,
          repeat: -1
        })
        this.scene.anims.create({
          key: 'malvinDie',
          frames: this.scene.anims.generateFrameNumbers('icyattack', { start: 36, end: 44 }),
          frameRate: 10,
          repeat: -1
        })

      },

      ////////////////////////////////////////////////////////////////////////////////////////////

      hunt: function (targets) {
        if (!this.dead) {
          this.direction = new Phaser.Math.Vector2(targets.x - this.x, targets.y - this.y);
          this.module = this.direction.length();
          if (this.module < this.attackRange) {
            this.setVelocityX(0);
            this.setVelocityY(0);
            this.attack(targets);
          } else {
            this.setVelocityX((this.direction.x / this.module) * this.speed);
            this.setVelocityY((this.direction.y / this.module) * this.speed);
          }

        }


      },

      /////////////////////////////////////////////////////////////////////////////////////////

      attack: function (targets) {
        this.actualTime = this.scene.time.now / 1000;

        if (this.actualTime > (this.timeSinceLastIncrement + this.attackCooldown)) {
          targets.health -= 10;
          targets.lifeBar.setCrop(0, 0, targets.health * 2, 32);
          console.log("Objetivo dañado");
          console.log("Vida restante = " + targets.health);
          this.timeSinceLastIncrement = this.scene.time.now / 1000;
        }

      }
    })



    //////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////////////////////
    //////////////////////////////////////////////////////////////////////////////////////////////////



    var MainGame = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:

        function MainGame() {
          Phaser.Scene.call(this, { key: 'mainGame' });

          this.player;

          this.enemy;


        },

      preload: function () {
        this.load.image('sky', 'assets/sky.png');
        this.load.image('escenario', 'assets/map.png');
        this.load.image('lifeBar1', 'assets/barraVida.png');
        this.load.image('lifeLevel', 'assets/nivelVida.png');
        this.load.image('musicActive', 'assets/musicaActiva.png');
        this.load.image('musicInactive', 'assets/musicaInactiva.png');
        this.load.image('pause', 'assets/star.png');
        this.load.spritesheet('icy', 'assets/icy.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('malvin', 'assets/malvin.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icyattack', 'assets/deathSpriteSheet.png', { frameWidth: 64, frameHeight: 64 });
        this.load.audio('escMusic', [
          'assets/Fantasy Zone - Keep on the Beat (Remastered).ogg',
          'assets/Fantasy Zone - Keep on the Beat (Remastered).mp3'
        ]);
        this.load.audio('hitSound', ['icyHit.mp3']);
      },

      create: function () {
        this.add.image(400, 300, 'sky');
        this.add.image(400, 300, 'escenario');

        this.player = new Player(this);
        this.enemy = new Enemy(this);

        // BOTONES
        var pause = this.add.image(400, 20, 'pause').setInteractive();
        var musicAct = this.add.image(10, 300, 'musicActive').setInteractive();
        var musicInact = this.add.image(10, 300, 'musicInactive').setInteractive();

        //JUGADORES
        // 1
        this.add.image(150, 50, 'lifeBar1');
        var life1 = this.add.image(150, 50, 'lifeLevel');
        life1.setCrop(0, 0, this.player.health * 2, 32);
        this.player.lifeBar = life1;
        // 2
        this.add.image(750, 50, 'lifeBar1');
        //var life2 = this.add.image(700,50,'lifeBar');
        //life2.setCrop(200 - (this.player.health * 2), 0, 200, 32);

        //MUSICA
        musicInact.visible = false;

        //this.player.hitSound = this.sound.add('hitSound');
        var music = this.sound.add('escMusic');
        //music.play();

        musicAct.on('pointerdown', function () {
          console.log("Musica desactivada");
          musicInact.visible = true;
          musicAct.visible = false;
          music.stop();
        });

        musicInact.on('pointerdown', function () {
          console.log("Musica activada");
          musicInact.visible = false;
          musicAct.visible = true;
          music.play();
        });

        //OPCIONES
        pause.on('pointerdown', function () {
          console.log("Pausa");
          // aqui se cambia al menu de pausa
        });


        this.physics.add.collider(this.player, this.enemy);
      },

      update: function () {

        this.player.move(this);
        this.enemy.hunt(this.player);
        this.player.attack(this.enemy);

        //this.life1.setCrop(0, 0, 200, 32);
        //this.life2.setCrop(0, 0, 200, 32);



      }
    });



    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////
    /////////////////////////////////////////////////////////////////////////////////////////////////



    const config = {
      type: Phaser.Auto,
      width: 800,
      height: 600,
      input: {
        gamepad: true
      },
      pixelArt: true,
      physics: {
        default: 'arcade',
        arcade: {
          gravity: { y: 0 },
          debug: true
        }
      },
      scene: [MainGame],
      audio: {
        disableWebAudio: true
      },
    };

    var game = new Phaser.Game(config);

  </script>
</body>



</html>
