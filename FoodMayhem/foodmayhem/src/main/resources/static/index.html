<!DOCTYPE html>
<html lang="es">

<head>
  <meta name="" charset="utf-8" content=""/>
  <title>Food Mayhem</title>
  <style>
           @font-face{
               font-family: 'estilo';
               src: url('./Assets/Fonts/serif_pixel-7.ttf');
           }
           @font-face{
               font-family: 'titulo';
               src: url('./Assets/Fonts/04B_30__.TTF');
           }
           @font-face{
               font-family: 'damage';
               src: url('./Assets/Fonts/I-pixel-u.ttf');
           }
       </style>

    <script src="js/phaser.min.js"></script>
    <script src="js/stateMachinePlayer.js"></script>
    <script src="js/enemiesClasses.js"></script>
    <script src="js/playerClasses.js"></script>
    <script src="js/Pantallas.js"></script>
    <script src="js/misc.js"></script>
    <script src="js/highScore.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"> </script>

    <link rel="stylesheet" media="all" href="./css/stylesheet.css">
</head>

<body style="text-align:center">
  
  <div class="bs-intro-text" id="introTextoP1">
    <input id="namebar" name="player1T" class="nk-namebar-input" type="text" placeholder="Introduce your name...">
    <input id="namebar2" name="player2T" class="nk-namebar-input" type="text" placeholder="Introduce your name...">
    <span class="nk-namebar-indicator"></span>
  </div>
  <div id="hS">
    <h1 id="finalScore"></h1>
    <ul id="highScores"></ul>
  </div>
</div>

<<<<<<< Updated upstream
  <div class="flex-container">
    <div id="content"></div>
    <div id="chatContainer">
      <div class="chatArea">
        <ul id="messages" class="messages"></ul>
      </div>
      <input id="inputMessage" class="inputMessage" placeholder="Type here..." type="text">
=======
<div id="input-form">
  <input type="text" name="name" class="input-style" id="name" placeholder="Usuario" />
  <p></p>
  <input type="password" class="input-style" id="password" name="password" placeholder="Contraseña" />
</div>

<div class="flex-container">
  <div id="content"></div>
  <div id="chatContainer">
    <div class="chatArea">
      <ul id="messages" class="messages"></ul>
>>>>>>> Stashed changes
    </div>
  </div>
<script type="text/javascript">


var player;
var player2;

var music;
var nxtSound;
var victoryMusic;
var defMusic;

const highScores = JSON.parse(localStorage.getItem("highScores")) || [];
const inputMessage = document.getElementById('inputMessage');
const messages = document.getElementById('messages');
const player1Name = document.getElementById('namebar');


window.addEventListener('keydown', event => {
  if (event.which === 13) {
    sendMessage();
  }
  if (event.which === 32) {
    if (document.activeElement === inputMessage) {
      inputMessage.value = inputMessage.value + ' ';
    }
  }
});

$(document).ready(function()
{ 
  updateChat();  
});


function sendMessage() {

  let message = inputMessage.value;
  let nick = player1Name.value;

  if (message && nick) {
    inputMessage.value = '';
    $.ajax({
        type: "POST",
        async:false,
        headers: {
            'Accept': 'application/json',
            'Content-type' : 'application/json'
        },
        url: '/chats',
        data: JSON.stringify( { nick: nick+': ', message: ""+ message } ),
        dataType: "json", error: function(xhr) {
        console.log(xhr);
      } 
    })
  }
}

function updateChat(){
  messages.innerHTML = '';
  $.ajax({ 
    url: '/chats',
  }).done(function(data) 
  { 
    for(var k in data) {
      const usernameSpan = document.createElement('span');
      const usernameText = document.createTextNode(data[k].nick);
      usernameSpan.className = 'username';
      usernameSpan.appendChild(usernameText);
      const messageBodySpan = document.createElement('span');
      const messageBodyText = document.createTextNode(data[k].message);
      messageBodySpan.className = 'messageBody';
      messageBodySpan.appendChild(messageBodyText);
      const messageLi = document.createElement('li');
      messageLi.setAttribute('username', data[k].nick);
      messageLi.append(usernameSpan);
      messageLi.append(messageBodySpan);
      addMessageElement(messageLi); 
    }
 })

    setTimeout(updateChat, 5000);
}

function addMessageElement(el) {
  messages.append(el);
  //messages.lastChild.scrollIntoView();
}

var MainGame = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:

        function MainGame() {
          Phaser.Scene.call(this, { key: 'mainGame' });

          this.players;
          this.enemies;

          this.level= 0;

          this.life1; 


        },

      preload: function () {
    
        //Imágenes de escenario
        this.load.image('map', 'Assets/Scenaries/Map/map1.png');
        this.load.image('valla', 'Assets/Scenaries/Decoration/Fences/fenceType1.png');
        this.load.image('valla1', 'Assets/Scenaries/Decoration/Fences/fenceType2.png');
        this.load.image('valla2', 'Assets/Scenaries/Decoration/Fences/fenceType3.png');
        this.load.image('valla3', 'Assets/Scenaries/Decoration/Fences/fenceType4.png');

        this.load.image('arbolB', 'Assets/Scenaries/Decoration/Trees/whiteTree.png');
        this.load.image('arbolN', 'Assets/Scenaries/Decoration/Trees/orangeTree.png');
        this.load.image('arbolR', 'Assets/Scenaries/Decoration/Trees/pinkTree.png');
        this.load.image('arbolV', 'Assets/Scenaries/Decoration/Trees/greenTree.png');

        this.load.image('lifeBarP1', 'Assets/Interfaces/InGame/LifeBars/barraVidaP1.png');
        this.load.image('lifeBarP2', 'Assets/Interfaces/InGame/LifeBars/barraVidaP2.png');
        this.load.image('BckBarP1', 'Assets/Interfaces/InGame/LifeBars/healthBarBGp1.png');
        this.load.image('BckBarP2', 'Assets/Interfaces/InGame/LifeBars/healthBarBGp2.png');

        //Inventario
        this.load.image('inventoryOpenP1', 'Assets/Interfaces/InGame/Inventory/inventarioAbierto.png');
        this.load.image('inventoryClosedP1', 'Assets/Interfaces/InGame/Inventory/inventarioCerrado.png');
        this.load.image('inventoryOpenP2', 'Assets/Interfaces/InGame/Inventory/inventarioAbiertoP2.png');
        this.load.image('inventoryClosedP2', 'Assets/Interfaces/InGame/Inventory/inventarioCerradoP2.png');

        this.load.image('sword', 'Assets/Objects/espada.png');
        this.load.image('swordSelec', 'Assets/Objects/espadaSelec.png');
        this.load.image('wand', 'Assets/Objects/varitaSauco.png');
        this.load.image('wandSelec', 'Assets/Objects/varitaSaucoMarcada.png');

        this.load.image('bolaP1', 'Assets/Characters/SpritesheetJugadores/SpritesheetP1/bola.png');
        this.load.image('bolaP2', 'Assets/Characters/SpritesheetJugadores/SpritesheetP2/bolaP2.png');


        this.load.spritesheet('musicButton', 'Assets/Interfaces/Buttons/MusicButton/musicButton.png',
         { frameWidth: 57, frameHeight: 41 });


        //Imágenes de Icy
        this.load.spritesheet('icy', 'Assets/Characters/SpritesheetJugadores/SpritesheetP1/icy.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icyB', 'Assets/Characters/SpritesheetJugadores/SpritesheetP2/Yci.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('yciattack', 'Assets/Characters/SpritesheetJugadores/SpritesheetP2/yciattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icyattack', 'Assets/Characters/SpritesheetJugadores/SpritesheetP1/icyattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('ycidistattack', 'Assets/Characters/SpritesheetJugadores/SpritesheetP2/ycidistattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icydistattack', 'Assets/Characters/SpritesheetJugadores/SpritesheetP1/icydistattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('icydmg', 'Assets/Characters/SpritesheetJugadores/DamageP1.png',{ frameWidth: 64, frameHeight: 64 });

        //Imágenes de Enemigos
        this.load.spritesheet('malvin', 'Assets/Characters/Enemies/malvin.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('demon', 'Assets/Characters/Enemies/demonBoss.png', { frameWidth: 32, frameHeight: 32 })
        this.load.spritesheet('malvinattack', 'Assets/Characters/Enemies/malvinattack.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('malvindeath', 'Assets/Characters/Enemies/malvinDeath.png', { frameWidth: 64, frameHeight: 64 });
        this.load.spritesheet('pause', 'Assets/Interfaces/Buttons/PlayPauseButtons/botonPause.png', { frameWidth: 80, frameHeight: 47 });


        //Sounds
        this.load.audio('escMusic', [
          'Assets/SoundFX/musicEsc.mp3'
        ]);
        this.load.audio('hitSound', ['Assets/SoundFX/icyHit.mp3']);
       this.load.audio('nxtSound', [ 'Assets/SoundFX/Success3.wav']);
       this.load.audio('vicMusic', [ 'Assets/SoundFX/Good_Time.mp3']);
       this.load.audio('defMusic', [ 'Assets/SoundFX/GameOver2.wav']);
       this.load.audio('plHurtSound', [ 'Assets/SoundFX/OuchSound.mp3']);
       this.load.audio('mlvDeadSound', [ 'Assets/SoundFX/Fire2.wav']);
      },

      create: function () {
        this.add.image(400, 380, 'map');
        this.input.mouse.disableContextMenu();

        this.blocks = this.physics.add.staticGroup();
        this.trees = this.physics.add.staticGroup();

        this.blocks.create(80, 65, 'valla').setScale(0.95).refreshBody();
        this.blocks.create(410, 139, 'valla1').setScale(0.95).refreshBody();
        this.blocks.create(547, 101, 'valla2').setScale(0.95).refreshBody();
        this.blocks.create(410, 334, 'valla3').setScale(0.95).refreshBody();

        //  this.smth = new EnemyMM(this,500,500,'malvin');

        //Declaración de PJs y NPCs
        this.enemies = this.add.group({
          classType: Malvin,
          runChildUpdate: false
        });

        this.bosses = this.add.group({
          classType: DemonBoss,
          runChildUpdate: false
        });

        this.generateEnemies(5, this.enemies, 'malvin');
        this.generateEnemies(1, this.bosses, 'demon');
        this.generateTrees(2);

        //Jugadores
        player1 = new P1(this, 300, 450);
        player2 = new P2(this, 500, 450);
        this.players = [player1, player2];

        //Control de colisiones de mundo
        this.initCollisions();

        // BOTONES
        pauseButton = this.add.sprite(400, 22, 'pause', 0).setInteractive();
        var musicButton = this.add.sprite(400, 570, 'musicButton', 0).setInteractive();
        var musicBtDown = this.add.sprite(400, 570, 'musicButton', 2).setInteractive().setVisible(false);

        // BARRAS DE VIDA
        this.add.image(100, 35, 'BckBarP1');
        player1.lifeBar = new LifeBar(this, 54, 26, 53, 30);
        this.add.image(100, 35, 'lifeBarP1');

        this.add.image(700, 35, 'BckBarP2');
        player2.lifeBar = new LifeBar(this, 614, 26, 687, 30);
        this.add.image(700, 35, 'lifeBarP2');

        //MUSICA
        music = this.sound.add('escMusic', {loop: true});
       nxtSound = this.sound.add('nxtSound', { loop: false})
         victoryMusic = this.sound.add('vicMusic', { loop: true});
         defMusic = this.sound.add('defMusic', { loop: false});

        music.play();

        musicButton.on("pointerover", function () {
          musicButton.setFrame(1);
        })
        musicButton.on("pointerout", function () {
          musicButton.setFrame(0);
        })
        musicButton.on('pointerdown', function () {
          console.log("Musica desactivada");
          musicBtDown.visible = true;
          musicButton.visible = false;
          musicBtDown.setFrame(1);
          music.stop()
        })

        musicBtDown.on("pointerover", function () {
          musicBtDown.setFrame(1);
        })
        musicBtDown.on("pointerout", function () {
          musicBtDown.setFrame(2);
        })
        musicBtDown.on('pointerdown', function () {
          console.log("Musica activada");
          musicBtDown.visible = false;
          musicButton.visible = true;
          musicButton.setFrame(1);
          music.play();

        })


        //OPCIONES
         pauseButton.on("pointerover", function () {
              pauseButton.setFrame(1);
           })
           pauseButton.on("pointerout", function () {
             pauseButton.setFrame(0);
          })

            pauseButton.on("pointerdown", ()=>{
                this.scene.launch("PantallaPausa");
                 this.scene.sleep();
           })

        this.physics.add.overlap(player1.attackHitbox, this.enemies, this.enemiesDamaged, undefined, this)
        this.physics.add.overlap(player2.attackHitbox, this.enemies, this.enemiesDamaged, undefined, this)
        this.physics.add.overlap(player1.attackHitbox, this.bosses, this.enemiesDamaged, undefined, this)
        this.physics.add.overlap(player2.attackHitbox, this.bosses, this.enemiesDamaged, undefined, this)
      },

      update: function () {

        updateChat();
        player1.move(this, this.enemies);

        player2.checkGamepad(this);


        player2.move();

        if(player2.control){
          if(player2.pad.isButtonDown(9)){
            this.scene.launch("PantallaPausa");
            this.scene.sleep();
          }
        }

      if (Phaser.Input.Keyboard.JustDown(player1.keys['esc'])){

          this.scene.launch("PantallaPausa");
          this.scene.sleep();
        }
        this.enemies.children.each(function (enem) {
          enem.initEnemy(this.players);
          enem.setSize(30, 30);
          enem.update();
        }, this);

        this.bosses.children.each(function (enem) {
          enem.setScale(2);
          enem.initEnemy(this.players);

        }, this);

        this.checkforLevel();

      },

      initCollisions: function () {
        this.add.existing(player1);
        this.physics.add.existing(player1);
        player1.setCollideWorldBounds(true);
        player1.setSize(30, 30);
        player1.setOffset(17, 28);

        this.add.existing(player2);
        this.physics.add.existing(player2);
        player2.setCollideWorldBounds(true);
        player2.setSize(30, 30);
        player2.setOffset(17, 28);
        //HitBox Enemigos


        //Colisiones de mundo

        this.physics.add.collider(player1, this.blocks);
        this.physics.add.collider(this.enemies, this.enemies);
        this.physics.add.collider(this.enemies, this.blocks);
        this.physics.add.collider(player2, this.blocks);
        this.physics.add.collider(this.bosses, this.enemies);
        this.physics.add.collider(this.bosses, this.blocks);

      },

      generateEnemies: function (number, enemies, sprite) {
        for (var i = 0; i < number; i++) {
          enemies.get(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), sprite);
        }
      },

      generateTrees: function (number) {
        for (var i = 0; i < number; i++) {
          this.blocks.create(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), 'arbolB').setScale(0.6).refreshBody();
          this.blocks.create(Phaser.Math.Between(100, 700)
            , Phaser.Math.Between(100, 500), 'arbolN').setScale(0.6).refreshBody();
          this.blocks.create(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), 'arbolR').setScale(0.6).refreshBody();
          this.blocks.create(Phaser.Math.Between(100, 700),
            Phaser.Math.Between(100, 500), 'arbolV').setScale(0.6).refreshBody();

        }


      },
      enemiesDamaged: function (player, enemy) {
        enemy.getHurt(player.attackDmg, player.ID);

      },

      checkforLevel: function() {
        if(!player1.dead || !player2.dead){
          if(this.level<3){
            if(this.enemies.countActive() === 0 && this.bosses.countActive() === 0 ) {
              this.generateEnemies(Phaser.Math.Between(3,10), this.enemies, 'malvin');
              this.generateEnemies(Phaser.Math.Between(0,4), this.bosses, 'demon');
              this.level++;
              nxtSound.play();
            }
          } else {
            console.log("Win")
            music.stop();
            if(!victoryMusic.isPlaying){
                    victoryMusic.play();
            }
            this.scene.start('ResultadoVictoria');
          }
        } else {
          console.log("Derrota")
          music.stop();
          if(!defMusic.isPlaying){
                  defMusic.play();
          }
          this.scene.start('ResultadoDerrota');
        }
      }

    });

  const config = {
    type: Phaser.Auto,
    width: 800,
    height: 600,
    input: {
      gamepad: true
    },
    pixelArt: true,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: {y: 0},
        debug: false
      }
    },
    dom:{
      createContainer: true
    },
    parent: 'container',
    backgroundColor: '#34495E',

    banner:{
    hidePhaser: false,
    text: '#000000',
    background: [
      'red',
      'yellow',
      'red',
      'transparent'
    ]
  },
  scene: [PantallaCarga, MainGame, PantallaInicio, PantallaCreditos, TwoCharacterSelect, PantallaPausa, ResultadoDerrota, ResultadoVictoria, HighScoresScreen]
  };

  var game = new Phaser.Game(config);

</script>
</body>



</html>
