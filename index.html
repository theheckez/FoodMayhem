<!DOCTYPE html>
<html lang="es">

<head>
  <meta name="" charset="utf-8" content=""/>
  <title>Food Mayhem</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
</head>

<body>
<script type="text/javascript">

  var Player = new Phaser.Class({
    Extends: Phaser.Physics.Arcade.Sprite,
    initialize:

    function Player(newScene) {
      Phaser.Physics.Arcade.Sprite.call(this, newScene, 500,450, 'dude');

      newScene.add.existing(this);
      newScene.physics.add.existing(this);

      this.health = 100;
      this.attack = 10;
      this.speed = 100;
      this.scene = newScene;

      this.keys;
      this.pad;

      this.initInput();
      this.initAnimations();

    },

    move: function(scene) {
      this.pad = this.scene.input.gamepad.getPad(0);

      if (this.scene.input.gamepad.total === 0)
    {
      this.setVelocity(0);


      if(this.keys['left'].isDown) {
        this.setVelocityX(-this.speed);
      !this.anims.isPlaying && this.anims.play('left',true);
      } else if(this.keys['right'].isDown) {
        this.setVelocityX(this.speed);
            !this.anims.isPlaying && this.anims.play('right',true);
      }

      if(this.keys['up'].isDown) {
        this.setVelocityY(-this.speed);
            !this.anims.isPlaying && this.anims.play('up',true);
      } else if (this.keys['down'].isDown){
        this.setVelocityY(this.speed);
            !this.anims.isPlaying && this.anims.play('down',true);
    }

    } else {
      if (this.pad.axes.length)
     {

       var axisH = this.pad.axes[0].getValue();
       var axisV = this.pad.axes[1].getValue();

       this.setVelocityX(this.speed * axisH);
       this.setVelocityY(this.speed * axisV);
    }
    }




    },

    initAnimations: function() {

      this.scene.anims.create({
        key: 'down',
        frames: this.scene.anims.generateFrameNumbers('icy', { start: 7, end: 12 }),
        frameRate: 10,
        repeat: -1
      });

       this.scene.anims.create({
        key: 'turn',
        frames: this.scene.anims.generateFrameNumbers('icy', {start: 0, end:4 }),
        frameRate: 10,
        repeat: -1
      });

      this.scene.anims.create({
        key:'up',
        frames: this.scene.anims.generateFrameNumbers('icy', {start:14, end:19}),
        frameRate:10,
        repeat:-1
      });

      this.scene.anims.create({
        key: 'left',
        frames: this.scene.anims.generateFrameNumbers('icy',{start:28,end:32}),
        frameRate:15,
        repeat: -1
      });

      this.scene.anims.create({
        key: 'right',
        frames: this.scene.anims.generateFrameNumbers('icy',{start:21,end:25}),
        frameRate: 15,
        repeat: -1
      })
    },

    initInput: function() {

      this.keys = this.scene.input.keyboard.addKeys({
       'up': Phaser.Input.Keyboard.KeyCodes.W,
       'down': Phaser.Input.Keyboard.KeyCodes.S,
       'left': Phaser.Input.Keyboard.KeyCodes.A,
       'right': Phaser.Input.Keyboard.KeyCodes.D
     });
    }


  });

  var Enemy = new Phaser.Class({
    Extends: Phaser.Physics.Arcade.Sprite,
    initialize:


    function Enemy(newScene) {
      Phaser.Physics.Arcade.Sprite.call(this,newScene, 500, 200, 'malvin');

      this.timeSinceLastIncrement = -4;
      this.actualTime;

      this.health = 100;
      this.speed = 70;

      this.attackDmg = 10;
      this.attackRange = 50;
      this.attackCooldown = 4;

      this.scene = newScene;
      newScene.add.existing(this);
      newScene.physics.add.existing(this);

      this.initAnimations();
    },

    initAnimations: function() {
      this.scene.anims.create({
        key:'malvinDown',
        frames: this.scene.anims.generateFrameNumbers('malvin', {start:0,end:5}),
        frameRate: 10,
        repeat: -1
      })

    },

    hunt: function(targets) {

      this.direction = new Phaser.Math.Vector2(targets.x - this.x, targets.y - this.y);
      this.module = this.direction.length();
      if(this.module < this.attackRange) {
        this.setVelocityX(0);
        this.setVelocityY(0);
        this.attack(targets);
      } else{
        this.setVelocityX((this.direction.x/this.module) * this.speed);
        this.setVelocityY((this.direction.y/this.module) * this.speed);
      }

    },

    attack: function(targets) {
      this.actualTime = this.scene.time.now/1000;

      if(this.actualTime>(this.timeSinceLastIncrement+this.attackCooldown)){
        targets.health-= 10;
        console.log("Objetivo da√±ado");
        console.log("Vida restante = " + targets.health);
        this.timeSinceLastIncrement = this.scene.time.now/1000;
      }

    }
  })

  var MainGame = new Phaser.Class({
    Extends: Phaser.Scene,

    initialize:

    function MainGame() {
       Phaser.Scene.call(this, { key: 'mainGame' });

       this.player;

       this.enemy;


    },

    preload: function(){
      this.load.image('sky', 'assets/sky.png');
      this.load.spritesheet('icy', 'assets/icy.png', {frameWidth: 64, frameHeight: 64});
      this.load.spritesheet('malvin', 'assets/malvin.png', {frameWidth: 64, frameHeight: 64});
    },

    create: function() {
      this.add.image(400,300,'sky');

      this.player = new Player(this);
      this.enemy = new Enemy(this);

      this.physics.add.collider(this.player,this.enemy);
    },

    update: function() {

      this.player.move(this);
      this.enemy.hunt(this.player);
    }



  });

  const config = {
    type: Phaser.Auto,
    width: 800,
    height: 600,
    input: {
      gamepad: true
    },
    pixelArt: true,
    physics: {
      default: 'arcade',
      arcade: {
        gravity: {y: 0},
        debug: true
      }
    },
    scene: [ MainGame ]
  };

  var game = new Phaser.Game(config);

</script>
</body>



</html>
